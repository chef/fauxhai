# GitHub Copilot Instructions for chef/fauxhai

---

## 1. Repository Analysis & Structure

### Folder Structure Diagram

```
/ (root)
├── bin/                # CLI scripts (fauxhai)
├── examples/           # Usage examples (ChefSpec, RSpec)
├── habitat/            # Habitat packaging and test scripts
│   ├── plan.sh         # Habitat build plan (Linux/macOS)
│   ├── plan.ps1        # Habitat build plan (Windows)
│   └── tests/          # Habitat test scripts
├── lib/                # Main Ruby library code
│   ├── fauxhai.rb      # Main entrypoint
│   └── fauxhai/        # Fauxhai core modules
│       ├── exception.rb
│       ├── fetcher.rb
│       ├── mocker.rb
│       ├── runner.rb
│       ├── version.rb
│       ├── keys/       # SSH keys for fetcher
│       └── platforms/  # Ohai mock data (JSON, organized by platform)
├── spec/               # RSpec unit tests
├── .expeditor/         # Expeditor build automation config
├── .github/            # GitHub workflows, CODEOWNERS, Copilot instructions
├── Gemfile             # Ruby gem dependencies
├── Rakefile            # Build, validation, and test tasks
├── PLATFORMS.md        # Supported platforms/versions
├── platforms.json      # Platform metadata
├── README.md           # Project documentation
├── CONTRIBUTING.md     # Contribution guidelines
├── VERSION             # Gem version
├── sonar-project.properties # SonarQube config
└── fauxhai-chef.gemspec    # Gem specification
```

### Technologies Used
- **Languages:** Ruby (primary)
- **Frameworks:** RSpec (testing), ChefSpec (usage), Habitat (packaging)
- **Build/Automation:** Rake, Expeditor
- **CI/CD:** GitHub Actions, Expeditor
- **Linting:** (Chefstyle recommended, not enforced)

### Project Purpose
Fauxhai provides a comprehensive, community-driven set of Ohai mock data for ChefSpec and other Chef ecosystem testing. It enables reliable, repeatable infrastructure tests by simulating real-world Ohai data for a wide variety of platforms and versions.

### File Modification Guidelines
- **Safe to Modify:**
  - `lib/fauxhai/` (except `platforms/` for non-platform changes)
  - `spec/` (unit tests)
  - `examples/`
  - `README.md`, `CONTRIBUTING.md`, `.github/`, `.expeditor/`
- **Prohibited/Restricted:**
  - `lib/fauxhai/platforms/`: Only add new or update existing platform JSONs as per contribution guidelines. Never delete or modify others' data without consensus.
  - `lib/fauxhai/keys/`: Do not modify or add keys unless updating fetcher logic.
  - `VERSION`: Only updated by release automation.
  - `platforms.json`, `PLATFORMS.md`: Generated by Rake tasks, do not edit manually.
- **Code Generation Patterns:**
  - Platform JSONs are generated via the `fauxhai` CLI and must be validated.
  - Never hand-edit generated files (`platforms.json`, `PLATFORMS.md`).

---

## 2. Development Workflow Integration

### Jira Integration (atlassian-mcp-server)
- When a Jira ID is provided, fetch the issue details using the MCP server.
- Read the story, clarify requirements, and plan implementation before coding.

### Workflow Phases & Prompts
- **Phase 1: Initial Setup & Analysis**
  - Prompt: "Jira issue <ID> loaded. Here is the summary and acceptance criteria: ... Do you approve proceeding to implementation planning?"
  - Approval gate: Wait for user confirmation.
- **Phase 2: Implementation Phase**
  - Prompt: "Implementation plan approved. Proceeding to code changes and documentation updates. Do you want to review the plan before I start?"
  - Approval gate: Wait for user confirmation.
- **Phase 3: Testing Phase**
  - Prompt: "Code changes complete. Now generating and running unit tests. Do you want to review the test plan before execution?"
  - Approval gate: Wait for user confirmation.
- **Phase 4: Pull Request Creation**
  - Prompt: "All tests pass and coverage >80%. Ready to create PR. Do you want to review the PR description before submission?"
  - Approval gate: Wait for user confirmation.

---

## 3. Testing Requirements (**Critical - Hard Requirement**)
- **All code changes MUST include comprehensive unit tests.**
- **Test coverage MUST be >80%. This is a non-negotiable requirement.**
- Use RSpec for all Ruby code. Place tests in `spec/`.
- Test both positive and negative scenarios, edge cases, and error conditions.
- Use mocks/stubs for external dependencies (e.g., network, file IO).
- Ensure tests are independent and can run in any order.
- **Coverage Verification:**
  - Use [SimpleCov](https://github.com/simplecov-ruby/simplecov) (add to `spec_helper.rb` if not present):
    ```ruby
    require 'simplecov'
    SimpleCov.start
    ```
  - Run tests and check coverage:
    ```bash
    bundle exec rspec
    open coverage/index.html
    ```
- **Test Command:**
  ```bash
  bundle exec rspec
  ```
- **Coverage Command:**
  ```bash
  open coverage/index.html
  ```
- **Emphasize:**
  - >80% coverage is required for PR approval. Builds will fail if not met.
  - Add tests for all new/changed code, including error handling.

---

## 4. Pull Request Creation Process
- **Branch name:** Use Jira ID (e.g., `PROJ-123`)
- **Git commands:**
  ```bash
  git checkout -b <JIRA_ID>
  # ...make changes...
  git add .
  git commit --signoff -m "<JIRA_ID>: <description>"
  git push origin <JIRA_ID>
  gh pr create --fill --label <label> --web
  ```
- **PR Description (HTML-formatted):**
  - Summary of changes
  - Link to Jira ticket: `<a href="https://jira.company.com/browse/<JIRA_ID>">Jira Ticket</a>`
  - List of changes
  - Testing performed and coverage results
  - List of files modified
  - Screenshots/examples if applicable

---

## 5. DCO (Developer Certificate of Origin) Compliance
- **ALL commits MUST use `--signoff` or `-s`.**
- Example:
  ```bash
  git commit --signoff -m "<JIRA_ID>: <description>"
  # To amend:
  git commit --amend --signoff --no-edit
  ```
- **Builds will fail without DCO signoff.**
- **Never submit unsigned commits.**

---

## 6. Build System Integration Analysis
- **Expeditor:**
  - Skip labels: `Expeditor: Skip All`, `Expeditor: Skip Version Bump`, `Expeditor: Skip Changelog`, `Expeditor: Skip Habitat`
  - Use skip labels for docs/test-only changes to avoid unnecessary builds.
  - Minor/major version bump labels: `Expeditor: Bump Version Minor`, `Expeditor: Bump Version Major`
  - Build channels: see `.expeditor/config.yml`
  - Automation triggers: PR merge, label application
- **Rake:**
  - `rake` or `bundle exec rake` runs validation and tests
  - `rake validate:json` validates all platform JSONs
  - `rake documentation:update_platforms` regenerates `PLATFORMS.md`
  - `rake update_json_list` updates `platforms.json`
- **Habitat:**
  - Use `habitat/plan.sh` and `plan.ps1` for packaging
  - Test scripts in `habitat/tests/`
- **CI/CD:**
  - GitHub Actions, Expeditor, Habitat pipelines

---

## 7. Label Management System
- **Available labels:**
  - `bug`, `documentation`, `duplicate`, `enhancement`, `good first issue`, `help wanted`, `invalid`, `question`, `wontfix`, `waiting on contributor`, `Expeditor: Skip All`, `Expeditor: Skip Version Bump`, `Expeditor: Skip Habitat`, `Expeditor: Bump Version Minor`, `Expeditor: Bump Version Major`, `oss-standards`
- **Label selection matrix:**
  - Docs only: `documentation`, `Expeditor: Skip All`
  - Feature: `enhancement`, `Expeditor: Bump Version Minor`
  - Bug fix: `bug`
  - Test only: `Expeditor: Skip Version Bump`
  - Habitat: `Expeditor: Skip Habitat`
- **Always use actual repo labels, not generic placeholders.**

---

## 8. Prompt-Based Execution Protocol
- **After each major step:** Provide a summary of what was completed.
- **Before next step:** Clearly state what the next step will be.
- **Ask for confirmation:** "Do you want me to continue with the next step?"
- **List remaining steps:** Show what steps are left.
- **Wait for approval:** Do not proceed until user confirms.
- **Example interaction:**
  - "Phase 1 complete: Jira analysis and planning. Next: code implementation. Do you want to continue? Remaining: implementation, testing, PR."

---

## 9. Repository-Specific Guidelines
- **Build:** Use Rake tasks for validation and test. Do not edit generated files.
- **Dependencies:** Use Bundler for Ruby gems. Run `bundle install` before development.
- **Habitat:** Use provided plans for packaging. Do not modify unless updating packaging logic.
- **Prohibited files:** Never edit `platforms.json`, `PLATFORMS.md`, or `VERSION` directly.
- **Platform:** macOS, Linux, Windows supported. Use correct plan for your OS.
- **Integration:** Chef ecosystem, ChefSpec, Ohai, Expeditor, Habitat.

---

## 10. Code Quality & Standards
- **Style:** Follow Ruby community standards. Chefstyle recommended.
- **Linting:** Add Chefstyle to Gemfile if not present. Run `bundle exec chefstyle`.
- **Security:** No secrets in code. Sanitize all platform data. Follow Apache 2.0 license.
- **Performance:** Avoid slow tests. Use caching for fetcher.
- **Review:** See CODEOWNERS for review requirements. All code must be reviewed by an owner/approver.

---

## 11. Security and Compliance Requirements
- **CVE awareness:** Monitor dependencies for vulnerabilities.
- **FIPS:** Ensure compatibility if required by downstream consumers.
- **License:** Apache 2.0. All contributions must comply.
- **Security scanning:** Use SonarQube (`sonar-project.properties`).
- **No secrets:** Never commit credentials or sensitive data.

---

## 12. Build & Development Environment
- **Setup:**
  - `bundle install`
  - `bundle exec rake`
- **Build commands:**
  - `rake` (default: validate JSON, run specs)
  - `rake validate:json`
  - `rake documentation:update_platforms`
- **Habitat:**
  - `hab studio enter && build`
- **Troubleshooting:**
  - Bundler errors: run `bundle install`
  - JSON validation: run `rake validate:json`
  - Test failures: run `bundle exec rspec`

---

## 13. Integration & Dependencies
- **Ecosystem:** ChefSpec, Ohai, Expeditor, Habitat
- **External services:** None required for core usage. Use MCP server for Jira integration.
- **API:** No external API dependencies.
- **Database:** None.
- **MCP server:** Configure as per atlassian-mcp-server docs for Jira integration.

---

## 14. Release & CI/CD Awareness
- **Pipelines:** GitHub Actions, Expeditor, Habitat
- **Release:** Automated via Expeditor on PR merge
- **Channels:** See `.expeditor/config.yml`
- **Manual release:** Not required for new platform data
- **Notifications:** Slack channel `chef-ws-notify`

---

## 15. Code Ownership & Review Process
- **CODEOWNERS:**
  - All files: `@chef/chef-workstation-owners @chef/chef-workstation-approvers @chef/chef-workstation-reviewers @jaymzh`
  - Markdown: `@chef/docs-team`
- **Review:** All PRs require review by a code owner.
- **Special files:** Markdown changes require docs team review.

---

## 16. Important Development Notes
- **All work is performed locally.**
- **Ask for clarification if requirements are unclear.**
- **Never edit generated or version files directly.**
- **Troubleshooting:**
  - Bundler: `bundle install`
  - Rake: `bundle exec rake`
  - Habitat: see `habitat/plan.sh` or `plan.ps1`
- **Performance:** Use caching, avoid slow tests.

---

## 17. Example Workflow Execution

### Example: Feature Implementation

1. **Phase 1:**
   - Copilot: "Jira issue PROJ-123 loaded. Summary: ... Do you approve proceeding to implementation planning?"
   - User: "Yes."
2. **Phase 2:**
   - Copilot: "Implementation plan: ... Do you want to review before I start?"
   - User: "Proceed."
3. **Phase 3:**
   - Copilot: "Code changes complete. Now generating and running unit tests. Do you want to review the test plan before execution?"
   - User: "Continue."
4. **Phase 4:**
   - Copilot: "All tests pass and coverage >80%. Ready to create PR. Do you want to review the PR description before submission?"
   - User: "Submit."

### Example: Documentation Change

- Branch: `DOCS-456`
- Label: `documentation`, `Expeditor: Skip All`
- PR description: HTML-formatted summary, link to Jira, list of changes, test results (if any)

---

## 18. Technology-Specific Guidelines

### Ruby
- **Dependency management:** Bundler (`Gemfile`)
- **Testing:** RSpec (`spec/`), see `spec_helper.rb`
- **Coverage:** Add SimpleCov to `spec_helper.rb` if not present
- **Linting:** Chefstyle recommended
- **Gem management:** Use `fauxhai-chef.gemspec`

### Habitat
- **Packaging:** Use `habitat/plan.sh` (Linux/macOS), `plan.ps1` (Windows)
- **Testing:** Use scripts in `habitat/tests/`

### Node.js, Go, Python, Java
- **Not used in this repository.**

---

## 19. Advanced Configuration Management
- **Config files:** `.expeditor/config.yml`, `sonar-project.properties`
- **Environment variables:** `DEBUG`, `SEED` (for RSpec)
- **Secrets:** Never commit secrets or credentials
- **Database:** None
- **Service config:** None required

---

## Key Requirements Summary
- [x] Repository structure diagram
- [x] DCO signoff requirements in all commit examples
- [x] >80% test coverage requirement mentioned multiple times
- [x] Actual repository labels (not generic ones)
- [x] Build system integration (Expeditor, Rake, Habitat)
- [x] Prompt-based workflow examples
- [x] Technology-specific testing patterns
- [x] Complete Git workflow with proper commands
- [x] Security and compliance requirements
- [x] Troubleshooting section
- [x] Example interaction patterns

---

**For any questions, ask for clarification before proceeding. Always follow the prompt-based, approval-gated workflow.**
